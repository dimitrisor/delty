name: Deploy1

permissions:
  packages: write
  contents: read

# The workflow will run whenever a push occurs on the main branch
on:
  push:
    branches: [main]

env:
  TAG: ${{ ( github.event_name == 'pull_request' && format('pr-{0}', github.event.number) ) || 'latest' }}

jobs:
  production-deploy:
    name: "Deploy to Production"
    needs: []
    runs-on: ubuntu-latest
    steps:
    - name: SSH to Hetzner Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DELTY_HETZNER_IP }}
        username: ${{ secrets.DELTY_HETZNER_USERNAME }}
        key: ${{ variables.DELTY_SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # Pull the latest application container
          docker pull ghcr.io/dimitrisor/delty:latest

          # Stop and remove existing application container
          docker stop delty || true
          docker rm delty || true

          # Run the Django application with Gunicorn
          docker run -d --name delty \
            -p 8000:8000 \
            --env-file /home/diorfano/app/.env \
            ghcr.io/dimitrisor/delty:latest \
            bash -c "cron && gunicorn delty.wsgi:application --bind 0.0.0.0:8000 --workers 3"

          # Stop and remove existing worker container
          docker stop delty-worker || true
          docker rm delty-worker || true

          # Run the Delty worker service
          docker run -d --name delty-worker \
            --env-file /home/diorfano/app/.env \
            ghcr.io/dimitrisor/delty:latest \
            bash -c "cron && python manage.py rundramatiq --processes 2"
