name: Deploy1

permissions:
  packages: write
  contents: read

# The workflow will run whenever a push occurs on the main branch
on:
  push:
    branches: [main]

env:
  TAG: ${{ ( github.event_name == 'pull_request' && format('pr-{0}', github.event.number) ) || 'latest' }}

jobs:
  production-deploy:
    name: "Deploy to Production"
    needs: []
    runs-on: ubuntu-latest
    steps:
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DELTY_SSH_PRIVATE_KEY }}
      - name: Test SSH agent
        run: ssh-add -l

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DELTY_HETZNER_IP }} >> ~/.ssh/known_hosts

      # Step 3: SSH into the Hetzner server and deploy the Docker container
      - name: Deploy Django application
        run: |
          ssh -v -o StrictHostKeyChecking=no ${{ secrets.DELTY_HETZNER_USERNAME }}@${{ secrets.DELTY_HETZNER_IP }} << 'EOF'

          # Pull the latest application container
          docker pull ghcr.io/dimitrisor/delty:latest

          # Stop and remove existing application container
          docker stop delty || true
          docker rm delty || true

          # Run the Django application with Gunicorn
          docker run -d --name delty \
            -p 8000:8000 \
            --env-file /home/diorfano/app/.env \
            ghcr.io/dimitrisor/delty:latest \
            bash -c "cron && gunicorn delty.wsgi:application --bind 0.0.0.0:8000 --workers 3"

          # Stop and remove existing worker container
          docker stop delty-worker || true
          docker rm delty-worker || true

          # Run the Delty worker service
          docker run -d --name delty-worker \
            --env-file /home/diorfano/app/.env \
            ghcr.io/dimitrisor/delty:latest \
            bash -c "cron && python manage.py rundramatiq --processes 2"

          EOF
